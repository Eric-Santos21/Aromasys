{% extends "layout.html" %}

{% block content %}

<div class="checkout-stepper">
    <div class="step active done"> <div class="step-number">1</div>
        <div class="step-label">Sacola</div>
    </div>
    <div class="step-line active"></div>
    <div class="step active"> <div class="step-number">2</div>
        <div class="step-label">Entrega</div>
    </div>
    <div class="step-line"></div>
    <div class="step"> <div class="step-number">3</div>
        <div class="step-label">Pagamento</div>
    </div>
    <div class="step-line"></div>
    <div class="step"> <div class="step-number">4</div>
        <div class="step-label">Sucesso</div>
    </div>
</div>

<div class="checkout-page-container">
    
    <div class="checkout-details">
        <h2>Confirmação de Pedido</h2>
        
        <div class="checkout-box">
            <h3><i class="fas fa-map-marker-alt"></i> 1. Endereço de Entrega</h3>
            <div class="address-details">
                <strong>{{ current_user.nome }}</strong>
                {% if current_user.enderecos %}
                    <p>{{ current_user.enderecos }}</p>
                {% else %}
                    <p style="color: #888">Nenhum endereço cadastrado</p>
                {% endif %}
            </div>
            <a href="{{ url_for('perfil') }}?tab=enderecos-pane&next={{ url_for('confirmacao') }}" class="btn-secondary">Trocar Endereço</a>
        </div>

        <div class="checkout-box">
            <h3><i class="fas fa-truck"></i> 2. Opções de Entrega</h3>
            <div class="delivery-options">
                <label for="entrega" class="delivery-option active" style="cursor: pointer;">
                    <input type="radio" name="delivery_type" id="entrega" value="entrega" checked>
                    <div class="delivery-option-info">
                        <strong>Entrega Padrão</strong>
                        <span>Receba em até 5 dias úteis</span>
                    </div>
                    <span class="delivery-option-price">R$ 15,00</span>
                </label>

                <label for="retirada" class="delivery-option" style="cursor: pointer;">
                    <input type="radio" name="delivery_type" id="retirada" value="retirada">
                    <div class="delivery-option-info">
                        <strong>Retirar na Loja</strong>
                        <span>Disponível em 2 horas</span>
                    </div>
                    <span class="delivery-option-price" style="color: green;">Grátis</span>
                </label>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            {% if current_user.enderecos %}
                <a href="{{ url_for('pagamento') }}" class="btn-checkout btn-full-width" style="display: block; text-align: center; text-decoration: none;">
                    Ir para o Pagamento
                </a>
            {% else %}
                <button class="btn-checkout btn-full-width" disabled style="opacity: 0.6; cursor: not-allowed; width: 100%;">
                    Cadastre um endereço primeiro
                </button>
            {% endif %}
            
            <a href="{{ url_for('carrinho') }}" class="link-voltar" style="text-align: center; display: block; margin-top: 15px; text-decoration: none; color: #666;">
                <i class="fas fa-arrow-left"></i> Voltar para a Sacola
            </a>
        </div>
    </div>
    
    <div class="cart-summary">
        <h3>Resumo do Pedido</h3>
        
        <div class="summary-row">
            <span>Subtotal</span>
            <span id="subtotal-value" data-value="{{ subtotal }}">R$ {{ "%.2f"|format(subtotal)|replace('.', ',') }}</span>
        </div>

        <div class="summary-row">
            <span>Frete</span>
            <span id="frete-value">R$ {{ "%.2f"|format(frete)|replace('.', ',') }}</span>
        </div>

        <div class="summary-divider"></div>

        <div class="summary-total">
            <span>Total</span>
            <strong id="total-value">R$ {{ "%.2f"|format(total)|replace('.', ',') }}</strong>
        </div>
    </div>

</div>

<script>
    // --- Toast simples (Feedback visual) ---
    function showToast(message){
        const container = document.getElementById('toast-container') || document.body;
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('show'));
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function(){
        const subtotalEl = document.getElementById('subtotal-value');
        const freteEl    = document.getElementById('frete-value');
        const totalEl    = document.getElementById('total-value');
        const radioButtons = document.querySelectorAll('.delivery-option input[type="radio"]');

        // Pega o valor numérico bruto que colocamos no atributo data-value (mais seguro)
        const subtotal = parseFloat(subtotalEl.getAttribute('data-value'));

        // Função para formatar dinheiro (1200.5 -> R$ 1.200,50)
        const formatPrice = val => 'R$ ' + val.toFixed(2).replace('.', ',');

        function updateSummary(frete){
            // Atualiza visual do Frete
            freteEl.textContent = frete === 0 ? 'Grátis' : formatPrice(frete);
            
            // Atualiza visual do Total (Subtotal + Frete)
            const novoTotal = subtotal + frete;
            totalEl.textContent = formatPrice(novoTotal);
        }

        // Configura cliques nas opções
        radioButtons.forEach(radio => {
            radio.addEventListener('change', function(){
                // Remove classe active de todos e adiciona no selecionado
                document.querySelectorAll('.delivery-option').forEach(opt => opt.classList.remove('active'));
                this.closest('.delivery-option').classList.add('active');

                // Define valor do frete
                const frete = this.value === 'retirada' ? 0 : 15;
                
                // Recalcula
                updateSummary(frete);

                showToast('Opção de entrega alterada: ' + (frete === 0 ? 'Retirada' : 'Entrega'));
            });
        });
    });
</script>

{% endblock %}