{% extends "layout.html" %}

{% block content %}
<div class="profile-page-container">
    
    <nav class="profile-nav">
        <div class="profile-user-info">
            <div class="profile-placeholder-icon"><i class="fas fa-user"></i></div>
            <h4>{{ current_user.nome or 'Usuário' }}</h4>
            <p>{{ current_user.email }}</p>
        </div>

        <ul id="profile-menu">
            <li class="active" data-target="meus-pedidos-pane">
                <a href="#">
                    <i class="fas fa-box-open"></i>
                    <span>Meus Pedidos</span>
                </a>
            </li>
            <li data-target="meus-dados-pane">
                <a href="#">
                    <i class="fas fa-user-edit"></i>
                    <span>Meus Dados</span>
                </a>
            </li>
            <li data-target="enderecos-pane">
                <a href="#">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Endereços</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sair</span>
                </a>
            </li>
        </ul>
    </nav>
    
    <div class="profile-content">
        
        <div id="meus-pedidos-pane" class="profile-pane active">
            <h2>Meus Pedidos</h2>
            <div class="order-list">
                {% for order in orders %}
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-info-group">
                            <span>Número do Pedido</span>
                            <strong>{{ order.id }}</strong>
                        </div>
                        <div class="order-info-group">
                            <span>Data</span>
                            <strong>{{ order.date }}</strong>
                        </div>
                        <div class="order-info-group">
                            <span>Total</span>
                            <strong>R$ {{ "%.2f"|format(order.total) }}</strong>
                        </div>
                    </div>
                    <div class="order-body">
                        {% if order.status == 'Entregue' %}
                            <span class="order-status status-delivered">{{ order.status }}</span>
                        {% elif order.status == 'Cancelado' %}
                            <span class="order-status status-cancelled">{{ order.status }}</span>
                        {% else %}
                            <span class="order-status">{{ order.status }}</span>
                        {% endif %}
                    </div>
                    <div class="order-items-preview">
                        {% for item in order.items %}
                        {% set img = item.product.image_url %}
                        {% if img and 'http' in img %}
                            <img src="{{ img }}" alt="{{ item.product.name }}" title="{{ item.product.name }}">
                        {% else %}
                            <img src="{{ url_for('static', filename=img) }}" alt="{{ item.product.name }}" title="{{ item.product.name }}">
                        {% endif %}
                        {% endfor %}
                    </div>
                    <div class="order-footer">
                        <a href="{{ url_for('pedido_detalhes', order_id=order.id) }}" class="btn-secondary">Ver Detalhes do Pedido</a>
                    </div>
                </div>
                {% endfor %}

                {% if not orders %}
                <div class="checkout-box text-center">
                    <p>Você ainda não fez nenhum pedido.</p>
                    <a href="{{ url_for('home') }}" class="btn-primary">Ver Produtos</a>
                </div>
                {% endif %}
            </div>
        </div> <div id="meus-dados-pane" class="profile-pane">
            <h2>Meus Dados</h2>
            <div class="checkout-box">
                <form class="card-form" action="{{ url_for('perfil') }}" method="POST">
                    <div class="form-group">
                        <label for="nome-completo">Nome Completo</label>
                        <input type="text" id="nome-completo" name="nome" value="{{ current_user.nome }}" placeholder="Nome Completo" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" value="{{ current_user.email }}" placeholder="Email" required> 
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cpf">CPF</label>
                            <input type="text" id="cpf" name="cpf" value="{{ current_user.cpf|format_cpf }}" placeholder="123.456.789-00" maxlength="14"> 
                        </div>
                        <div class="form-group">
                            <label for="telefone">Telefone / Celular</label>
                            <input type="text" id="telefone" name="telefone" value="{{ current_user.telefone|format_phone }}" placeholder="(83) 91234-5678" maxlength="15">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-primary" style="align-self: flex-start; margin-top: 10px;">
                        Salvar Alterações
                    </button>
                </form>
            </div>
        </div> <div id="enderecos-pane" class="profile-pane">
            <h2>Meus Endereços</h2>
            <div class="address-list">
                {% if current_user.enderecos %}
                <div class="address-card checkout-box">
                    <div class="address-card-header">
                        <strong><i class="fas fa-home"></i> Endereço</strong>
                    </div>
                    <div class="address-details">
                        <p>{{ current_user.enderecos }}</p>
                    </div>
                    <div class="address-card-actions">
                        <button class="btn-secondary" onclick="document.getElementById('address-form').style.display='flex'">Editar</button>
                    </div>
                </div>
                {% endif %}

                <button class="address-add-new" onclick="document.getElementById('address-form').style.display='flex'">
                    <i class="fas fa-plus"></i>
                    <span>{% if current_user.enderecos %}Alterar Endereço{% else %}Adicionar Novo Endereço{% endif %}</span>
                </button>

                <form id="address-form" class="modal-form" action="{{ url_for('perfil') }}" method="POST" style="display:none; flex-direction: column; gap: 8px;">
                    <div class="form-row">
                        <div class="form-group" style="flex:1">
                            <label>Rua / Avenida</label>
                            <input type="text" name="rua" required value="{{ (current_user.enderecos.split(',')[0]).strip() if current_user.enderecos else '' }}">
                        </div>
                        <div class="form-group" style="max-width:140px">
                            <label>Número</label>
                            <input type="text" name="numero" required value="{{ current_user.enderecos.split(',')[1].split('-')[0].strip() if current_user.enderecos and ',' in current_user.enderecos else '' }}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Complemento (opcional)</label>
                        <input type="text" name="complemento" value="{{ current_user.enderecos.split('-')[1].strip() if current_user.enderecos and '-' in current_user.enderecos else '' }}">
                    </div>
                    <button type="submit" class="btn-primary" style="align-self:flex-start">Salvar</button>
                </form>
            </div>
        </div> </div>
</div>

<script>
    // --- Função que SÓ permite números ---
    function restrictToNumbers(event) {
        if (event.isComposing || event.keyCode === 229) return;
        if ([46, 8, 9, 27, 13, 110, 190, 188, 190].includes(event.keyCode) ||
            (event.keyCode === 65 && (event.ctrlKey === true || event.metaKey === true)) ||
            (event.keyCode >= 35 && event.keyCode <= 40)) {
            return; 
        }
        if ((event.shiftKey || (event.keyCode < 48 || event.keyCode > 57)) && (event.keyCode < 96 || event.keyCode > 105)) {
            event.preventDefault();
        }
    }

    // --- Função que SÓ permite letras e espaço ---
    function restrictToLetters(event) {
        if (event.isComposing || event.keyCode === 229) return;
        if ([46, 8, 9, 27, 13, 32].includes(event.keyCode) || 
            (event.keyCode === 65 && (event.ctrlKey === true || event.metaKey === true)) ||
            (event.keyCode >= 35 && event.keyCode <= 40)) {
            return; 
        }
        if ((event.keyCode >= 48 && event.keyCode <= 57) || (event.keyCode >= 96 && event.keyCode <= 105)) {
            event.preventDefault();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        
        // --- Lógica das Abas ---
        const initialTab = "{{ initial_tab|default('') }}";
        const menuItems = document.querySelectorAll('#profile-menu li');
        const panes = document.querySelectorAll('.profile-pane');

        menuItems.forEach(item => {
            if (item.dataset.target) {
                item.addEventListener('click', function(e) {
                    e.preventDefault(); 
                    const targetId = this.dataset.target;
                    menuItems.forEach(mi => mi.classList.remove('active'));
                    panes.forEach(pane => pane.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(targetId).classList.add('active');
                });
            }
        });

        // Ativa a aba inicial se foi definida pelo backend
        if (initialTab) {
            const toActivate = document.querySelector(`#profile-menu li[data-target="${initialTab}"]`);
            if (toActivate) {
                toActivate.classList.add('active');
                panes.forEach(p => p.classList.remove('active'));
                document.getElementById(initialTab).classList.add('active');
            }
        }

        // --- Lógica das Máscaras ---
        
        // Nome Completo
        const nomeInput = document.getElementById('nome-completo');
        if (nomeInput) {
            nomeInput.addEventListener('keydown', restrictToLetters);
        }

        // --- Campo CPF ---
        const cpfInput = document.getElementById('cpf');
        if (cpfInput) {
            cpfInput.addEventListener('keydown', restrictToNumbers);
            cpfInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); 
                if (value.length > 9) {
                    value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                } else if (value.length > 6) {
                    value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
                } else if (value.length > 3) {
                    value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
                }
                e.target.value = value;
            });
        }

        // --- Campo Telefone ---
        const telefoneInput = document.getElementById('telefone');
        if (telefoneInput) {
            telefoneInput.addEventListener('keydown', restrictToNumbers);
            telefoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 10) {
                    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                } else if (value.length > 6) {
                    value = value.replace(/(\d{2})(\d{4})(\d{1,4})/, '($1) $2-$3');
                } else if (value.length > 2) {
                    value = value.replace(/(\d{2})(\d{1,5})/, '($1) $2');
                } else if (value.length > 0) {
                    value = value.replace(/(\d{1,2})/, '($1');
                }
                e.target.value = value;
            });
        }
    });
</script>
{% endblock %}